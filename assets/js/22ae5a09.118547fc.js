"use strict";(globalThis.webpackChunkdocs=globalThis.webpackChunkdocs||[]).push([[7418],{81(e,t,n){n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>a,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"gitlab","title":"GitLab CI","description":"release-plz can also run in GitLab CI/CD, however the setup is slightly more complex","source":"@site/docs/gitlab.md","sourceDirName":".","slug":"/gitlab","permalink":"/docs/gitlab","draft":false,"unlisted":false,"editUrl":"https://github.com/release-plz/release-plz/tree/main/website/docs/gitlab.md","tags":[],"version":"current","frontMatter":{},"sidebar":"tutorialSidebar","previous":{"title":"Persist credentials","permalink":"/docs/github/persist-credentials"},"next":{"title":"Configuration","permalink":"/docs/config"}}');var i=n(4848),r=n(8453);const o={},a="GitLab CI",l={},c=[{value:"1. Generate a token for release-plz",id:"1-generate-a-token-for-release-plz",level:2},{value:"2. Put the component definition in a repository",id:"2-put-the-component-definition-in-a-repository",level:2},{value:"3. Use the component in your repository",id:"3-use-the-component-in-your-repository",level:2},{value:"Using Git submodules hosted elsewhere",id:"using-git-submodules-hosted-elsewhere",level:3},{value:"Add extra options to <code>release-plz</code> commands",id:"add-extra-options-to-release-plz-commands",level:3}];function d(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(t.header,{children:(0,i.jsx)(t.h1,{id:"gitlab-ci",children:"GitLab CI"})}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"release-plz"})," can also run in GitLab CI/CD, however the setup is slightly more complex\nthan with the Github CI."]}),"\n",(0,i.jsx)(t.h2,{id:"1-generate-a-token-for-release-plz",children:"1. Generate a token for release-plz"}),"\n",(0,i.jsxs)(t.p,{children:[(0,i.jsx)(t.code,{children:"release-plz"})," authenticates with Gitlab via a token. This needs to be generated and added\nto the CI/CD variables:"]}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["Go to the group or repository where you want ",(0,i.jsx)(t.code,{children:"release-plz"})," to work."]}),"\n",(0,i.jsxs)(t.li,{children:["Go to Settings -> Access token -> Add new token","\n",(0,i.jsxs)(t.ul,{children:["\n",(0,i.jsx)(t.li,{children:"If you don't see the Access token menu, then you don't have sufficient permissions\nto create tokens"}),"\n"]}),"\n"]}),"\n",(0,i.jsxs)(t.li,{children:["Give the token the Maintainer role and grant the ",(0,i.jsx)(t.code,{children:"api"}),", ",(0,i.jsx)(t.code,{children:"read_api"}),", ",(0,i.jsx)(t.code,{children:"read_repository"}),",\nand ",(0,i.jsx)(t.code,{children:"write_repository"})," scopes"]}),"\n",(0,i.jsxs)(t.li,{children:["Configure this token as a masked variable named ",(0,i.jsx)(t.code,{children:"RELEASE_PLZ_TOKEN"})," in\nSettings -> CI/CD -> Variables -> Add variable"]}),"\n",(0,i.jsx)(t.li,{children:"Go to Manage -> Members and find the bot account that was created for this token\nand get the username"}),"\n",(0,i.jsxs)(t.li,{children:["The username can be converted to the email address using this format:\n",(0,i.jsx)(t.code,{children:"$USERNAME@noreply.gitlab.com"})]}),"\n",(0,i.jsxs)(t.li,{children:["Configure this email address as a variable named ",(0,i.jsx)(t.code,{children:"RELEASE_PLZ_BOT_EMAIL"})," in\nSettings -> CI/CD -> Variables -> Add variable"]}),"\n"]}),"\n",(0,i.jsx)(t.h2,{id:"2-put-the-component-definition-in-a-repository",children:"2. Put the component definition in a repository"}),"\n",(0,i.jsx)(t.p,{children:"The component definition below takes care of a lot of edgecases, and it's therefore recommended to\nput this in a separate repository and so that the component can be used by all your Rust repositories."}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",children:'spec:\n  inputs:\n    stage:\n      type: string\n      default: "deploy"\n      description: "At which stage this component runs"\n    image:\n      default: "rust"\n      description: "The Docker image to run in, needs to have `Cargo` installed"\n    cwd:\n      type: string\n      default: "."\n      description: "The directory where to run release-plz, relative to $CI_PROJECT_DIR"\n    tags:\n      type: array\n      default: []\n      description: "Tags to apply to this job"\n    git_credentials:\n      type: array\n      default: []\n      description: \'Credentials for a Git host in the form of `"https://user:pass@example.com"`, there\'s a default credential for `$CI_SERVER_HOST` which can be overwritten here\'\n    git_submodule_recursive:\n      type: boolean\n      default: false\n      description: "Recursively clone submodules before running release-plz"\n    bot_email:\n      type: string\n      default: "$RELEASE_PLZ_BOT_EMAIL"\n      description: "The email address associated with `$RELEASE_PLZ_TOKEN`"\n    bot_name:\n      type: string\n      default: "release-plz"\n      description: "The name to use as commit author"\n    release_args:\n      type: string\n      default: ""\n      description: "Arguments to pass to `release-plz release`"\n    pr_args:\n      type: string\n      default: ""\n      description: "Arguments to pass to `release-plz pr`"\n---\n.release-plz-defaults:\n  stage: $[[ inputs.stage ]]\n  image: $[[ inputs.image ]]\n  tags: $[[ inputs.tags ]]\n  variables:\n    # Clone the entire repo, this prevents issues with partial checkouts\n    GIT_STRATEGY: "clone"\n  rules:\n    - if: $CI_COMMIT_TAG\n      when: never\n    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH\n  cache:\n    # Cache the crates.io index and downloads\n    key: cargo-crates-io\n    paths:\n      - cargo_registry_index/\n      - cargo_registry_cache/\n  before_script:\n    # Restore the registry cache if it exists\n    # The `|| true` is so that the commands can fail if the cache is empty\n    - rm -rf "$CARGO_HOME/registry/index/" || true\n    - rm -rf "$CARGO_HOME/registry/cache/" || true\n    - mv cargo_registry_index/ "$CARGO_HOME/registry/index/" || true\n    - mv cargo_registry_cache/ "$CARGO_HOME/registry/cache/" || true\n    # Have git get credentials from a file\n    - git config --global credential.helper store\n    # Convert the `inputs.git_credentials` array into something that sh can understand\n    - GIT_CREDENTIALS=$(echo $(eval \'echo "$[[ inputs.git_credentials ]]"\') | tr -d \'[],"\')\n    - set -- $GIT_CREDENTIALS\n    # This will output an empty line if `inputs.get_credentials` is empty, this is officially not\n    # supported but Git accepts it anyway\n    - for cred in "$@"; do echo "$cred" >> ~/.git-credentials; done\n    # The `$CI_SERVER_HOST` default credential is done last, as Git stops reading at the first match\n    # Thus this allows a user to specify another credential for `$CI_SERVER_HOST`\n    - echo "$CI_SERVER_PROTOCOL://gitlab-ci-token:${RELEASE_PLZ_TOKEN}@$CI_SERVER_HOST" >> ~/.git-credentials\n    # Gitlab doesn\'t do a proper checkout, also recurse submodules if requested (Gitlab can do it, but not for repo\'s hosted elsewhere)\n    - git checkout $( if [ "$[[ inputs.git_submodule_recursive ]]" = "true" ]; then echo "--recurse-submodules"; fi ) "$CI_COMMIT_BRANCH"\n    - if [ $[[ inputs.git_submodule_recursive ]] = "true" ]; then git submodule update --init; fi\n    # Check that the branch hasn\'t updated before the CI got to start\n    - if [ "$( git rev-parse HEAD )" != "$CI_COMMIT_SHA" ]; then echo "$CI_COMMIT_BRANCH$ got updated after $CI_COMMIT_SHA, restart the CI on the latest commit"; exit 1; fi\n    # release-plz creates a commit, so Git needs an identity\n    - git config --global user.email "$[[ inputs.bot_email ]]"\n    - git config --global user.name "$[[ inputs.bot_name ]]"\n    # release-plz doesn\'t use git-token for repository authentication, see https://github.com/release-plz/release-plz/issues/2174\n    - git remote set-url origin "$CI_SERVER_PROTOCOL://anything:$RELEASE_PLZ_TOKEN@$CI_SERVER_HOST/$CI_PROJECT_PATH.git"\n    # Install binstall and release-plz, compiling from source would take too long\n    - curl -L --proto \'=https\' --tlsv1.2 -sSf https://raw.githubusercontent.com/cargo-bins/cargo-binstall/main/install-from-binstall-release.sh | bash\n    - cargo binstall release-plz\n    # Change to the user provided directory\n    - cd "$[[ inputs.cwd ]]"\n  after_script:\n    # Update the registry cache\n    - mv "$CARGO_HOME/registry/index/" cargo_registry_index/ || true\n    - mv "$CARGO_HOME/registry/cache/" cargo_registry_cache/ || true\n\n# Creates/updates a PR to update the version and changelog\nrelease-plz:pr:\n  extends: .release-plz-defaults\n  script:\n    - release-plz release-pr --forge gitlab --git-token "$RELEASE_PLZ_TOKEN" $[[ inputs.pr_args ]]\n\n# This only creates a release if the version in `Cargo.toml` is newer than the version on `crates.io`\nrelease-plz:release:\n  extends: .release-plz-defaults\n  script:\n    - release-plz release --forge gitlab --git-token "$RELEASE_PLZ_TOKEN" $[[ inputs.release_args ]]\n\n'})}),"\n",(0,i.jsx)(t.h2,{id:"3-use-the-component-in-your-repository",children:"3. Use the component in your repository"}),"\n",(0,i.jsxs)(t.p,{children:["By putting it at ",(0,i.jsx)(t.code,{children:"templates/release-plz/template.yml"})," it can be used in your repositories in\nyour ",(0,i.jsx)(t.code,{children:".gitlab-ci.yml"})," as:"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",children:"include:\n  - component: $CI_SERVER_FQDN/path/to/component/release-plz@branch_name\n"})}),"\n",(0,i.jsxs)(t.p,{children:["You can also configure the components via the inputs specified in the ",(0,i.jsx)(t.code,{children:"spec"})," section."]}),"\n",(0,i.jsx)(t.p,{children:"For example to change the stage at which the component runs:"}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",children:'include:\n  - component: $CI_SERVER_FQDN/path/to/component/release-plz@branch_name\n    inputs:\n      stage: "special_deploy_stage"\n'})}),"\n",(0,i.jsx)(t.h3,{id:"using-git-submodules-hosted-elsewhere",children:"Using Git submodules hosted elsewhere"}),"\n",(0,i.jsx)(t.p,{children:"If your repository contains submodules that are hosted on a different forge, for example Github,\nsome things need to be configured. This is only needed if the submodule is hosted elsewhere, Gitlab\nsupports cloning submodules from Gitlab repositories."}),"\n",(0,i.jsxs)(t.ol,{children:["\n",(0,i.jsxs)(t.li,{children:["Enable recursive cloning of submodules by setting ",(0,i.jsx)(t.code,{children:"git_submodule_recursive"})," to ",(0,i.jsx)(t.code,{children:"true"})]}),"\n",(0,i.jsxs)(t.li,{children:["Configure an access token for the Git host by setting ",(0,i.jsx)(t.code,{children:"git_credentials"})," to an array of strings\nwhich conform to ",(0,i.jsxs)(t.a,{href:"https://git-scm.com/docs/git-credential-store#_storage_format",children:["the ",(0,i.jsx)(t.code,{children:".git-credentials"})," storage format"]}),":"]}),"\n"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",children:'include:\n  - component: $CI_SERVER_FQDN/path/to/component/release-plz@branch_name\n    inputs:\n      git_submodule_recursive: true\n      git_credentials: ["https://${GH_USERNAME}:${GH_TOKEN}@github.com"]\n'})}),"\n",(0,i.jsxs)(t.h3,{id:"add-extra-options-to-release-plz-commands",children:["Add extra options to ",(0,i.jsx)(t.code,{children:"release-plz"})," commands"]}),"\n",(0,i.jsx)(t.pre,{children:(0,i.jsx)(t.code,{className:"language-yaml",children:'include:\n  - component: $CI_SERVER_FQDN/path/to/component/release-plz@branch_name\n    inputs:\n      release_args: "--dry-run"\n      pr_args: "-v --no-changelog"\n'})})]})}function h(e={}){const{wrapper:t}={...(0,r.R)(),...e.components};return t?(0,i.jsx)(t,{...e,children:(0,i.jsx)(d,{...e})}):d(e)}},8453(e,t,n){n.d(t,{R:()=>o,x:()=>a});var s=n(6540);const i={},r=s.createContext(i);function o(e){const t=s.useContext(r);return s.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:o(e.components),s.createElement(r.Provider,{value:t},e.children)}}}]);